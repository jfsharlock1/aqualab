﻿<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AquaLab — Digital Pool Chemistry</title>

  <!-- PWA essentials -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9" />

  <!-- iOS helpers -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <link rel="stylesheet" href="pooltest.css" />
</head>

<body>
  <header class="pt-header">
    <div class="logo"></div>
    <div class="titling">
      <h1>AquaLab</h1>
      <div class="muted">Scan a test strip → analyze water chemistry → get volume-aware, science-based recommendations</div>
    </div>
    <nav class="pt-nav">
      <a href="calibrate.html">Calibration Lab</a>
      <button type="button" class="btn-ghost" data-pt="poolToggleGlobal">Pool Setup</button>
    </nav>
  </header>

  <main class="container grid grid-2 pooltest">

    <!-- Pool setup / gallons -->
    <section class="card" data-pt="poolCard">
      <div class="card-header-row">
        <h2>Pool Setup</h2>
        <button type="button" class="card-toggle btn-ghost" data-pt="poolToggle">Hide</button>
      </div>

      <div class="card-body" data-pt="poolBody">
        <p class="muted hint">
          Enter pool shape and size so the app can estimate gallons and scale chemical recommendations.
        </p>

        <div class="field">
          <label>Pool shape</label>
          <select data-pt="shape">
            <option value="rect">Rectangular / Square</option>
            <option value="round">Round</option>
            <option value="oval">Oval</option>
          </select>
        </div>

        <!-- Rectangular fields -->
        <div class="shape-group" data-pt="rectFields">
          <div class="field">
            <label>Length (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="rectLen" placeholder="e.g., 30">
          </div>
          <div class="field">
            <label>Width (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="rectWid" placeholder="e.g., 15">
          </div>
        </div>

        <!-- Round fields -->
        <div class="shape-group" data-pt="roundFields" style="display:none">
          <div class="field">
            <label>Diameter (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="roundDia" placeholder="e.g., 18">
          </div>
        </div>

        <!-- Oval fields -->
        <div class="shape-group" data-pt="ovalFields" style="display:none">
          <div class="field">
            <label>Length (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="ovalLen" placeholder="e.g., 30">
          </div>
          <div class="field">
            <label>Width (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="ovalWid" placeholder="e.g., 15">
          </div>
        </div>

        <div class="field dual">
          <div>
            <label>Shallow depth (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="depthShallow" placeholder="e.g., 3">
          </div>
          <div>
            <label>Deep depth (ft)</label>
            <input type="number" min="0" step="0.1" data-pt="depthDeep" placeholder="e.g., 6">
          </div>
        </div>

        <div class="field">
          <label>Or enter gallons manually</label>
          <input type="number" min="0" step="100" data-pt="gallonsManual" placeholder="e.g., 15000">
          <small class="muted">Manual value overrides the shape calculation.</small>
        </div>

        <button type="button" data-pt="btnCalcGallons">Calculate Gallons</button>
        <p class="muted" data-pt="gallonsDisplay">Pool volume: – (enter shape/size or gallons)</p>
      </div>
    </section>

    <!-- Scanner -->
    <section class="card">
      <h2>Scanner (EasyTest strip only)</h2>

      <!-- Camera chooser (desktop/tablet) -->
      <div class="field" data-pt="cameraRow">
        <label>Camera (if available)</label>
        <select data-pt="cameraSelect">
          <option value="">Default camera</option>
        </select>
        <small class="muted">Tip: Plug in the webcam first, then refresh this page.</small>
      </div>

      <!-- Controls -->
      <div class="row row-wrap">
        <!-- Live controls -->
        <div class="live-controls" data-pt="liveControls">
          <button data-pt="btnStart">Enable Camera</button>
          <button data-pt="btnCapture" disabled>Capture</button>
          <button data-pt="btnWB" class="btn" disabled>Set White Balance</button>
        </div>

        <!-- Photo controls -->
        <div class="photo-controls" data-pt="photoControls">
          <button type="button" class="btn" data-pt="btnTakePhoto">Take Photo</button>
          <button type="button" class="btn" data-pt="btnChoosePhoto">Choose Photo</button>

          <input data-pt="takeInput" type="file" accept="image/*" capture="environment" hidden />
          <input data-pt="fileInput" type="file" accept="image/*" hidden />
        </div>
      </div>

      <!-- Camera box -->
      <div class="scan-view" data-pt="scanView">
        <video data-pt="video" playsinline muted></video>
        <canvas data-pt="canvas" hidden></canvas>

        <div class="scan-frame">
          <div class="scan-frame-label">Line strip up in this box</div>
        </div>
      </div>

      <!-- ✅ Preview + Crop UI (BELOW camera box) -->
      <div data-pt="previewWrap" class="preview-wrap" style="display:none; margin-top:12px;">
        <div data-pt="previewHeader" class="preview-header">
          <strong>Preview (drag/resize the box around the strip)</strong>
          <div class="preview-actions">
            <button type="button" class="btn-ghost" data-pt="btnAutoCrop">Auto-Crop Box</button>
            <button type="button" data-pt="btnUseCrop">Use Crop</button>
            <button type="button" class="btn-ghost" data-pt="btnCancelCrop">Cancel</button>
          </div>
        </div>

        <div data-pt="previewStage" class="preview-stage">
          <canvas data-pt="previewCanvas" class="preview-canvas"></canvas>

          <div data-pt="cropBox" class="cropbox">
            <div data-pt="cropHandle" class="crophandle"></div>
          </div>
        </div>

        <div data-pt="previewTip" class="preview-tip">
          Tip: Make the box tall and skinny. Include all pads.
        </div>
      </div>

      <p data-pt="status" class="muted" style="margin-top:8px;"></p>
    </section>

    <!-- Results -->
    <section class="card full-width">
      <div class="card-header-row">
        <h2>Results</h2>
        <button type="button" class="btn-ghost" data-pt="btnRecalc">Recalculate Tips</button>
      </div>

      <div class="bars">
        <div class="row"><h3>pH</h3><span data-pt="tagPh" class="tag">–</span></div>
        <div class="bar"><span data-pt="barPh"></span></div>

        <div class="row"><h3>Free Chlorine (ppm)</h3><span data-pt="tagFCl" class="tag">–</span></div>
        <div class="bar"><span data-pt="barFCl"></span></div>

        <div class="row"><h3>Total Chlorine (ppm)</h3><span data-pt="tagTCl" class="tag">–</span></div>
        <div class="bar"><span data-pt="barTCl"></span></div>

        <div class="row"><h3>Bromine (ppm)</h3><span data-pt="tagBr" class="tag">–</span></div>
        <div class="bar"><span data-pt="barBr"></span></div>

        <div class="row"><h3>Total Hardness (ppm)</h3><span data-pt="tagHard" class="tag">–</span></div>
        <div class="bar"><span data-pt="barHard"></span></div>

        <div class="row"><h3>Total Alkalinity (ppm)</h3><span data-pt="tagAlk" class="tag">–</span></div>
        <div class="bar"><span data-pt="barAlk"></span></div>

        <div class="row"><h3>Cyanuric Acid (ppm)</h3><span data-pt="tagCya" class="tag">–</span></div>
        <div class="bar"><span data-pt="barCya"></span></div>
      </div>

      <h3 style="margin-top:16px;">Volume-Aware Tips</h3>
      <ul data-pt="recs" class="muted"></ul>
    </section>

    <!-- History -->
    <section class="card full-width">
      <h2>History (saved on this device)</h2>
      <p class="muted hint">Each point is a reading saved in this browser using local storage.</p>

      <div class="row row-wrap" style="margin-bottom:8px;">
        <button type="button" class="btn-ghost danger" data-pt="btnClearData">
          Clear Saved Data (this device)
        </button>

        <button type="button" class="btn-ghost" data-pt="btnClearCache">
          Clear Scan Cache (debug)
        </button>
      </div>

      <div class="history-grid">
        <div><h3>pH</h3><canvas data-pt="chartPh"></canvas></div>
        <div><h3>Chlorine (ppm)</h3><canvas data-pt="chartFCl"></canvas></div>
        <div><h3>Total Alkalinity (ppm)</h3><canvas data-pt="chartAlk"></canvas></div>
        <div><h3>Cyanuric Acid (ppm)</h3><canvas data-pt="chartCya"></canvas></div>
      </div>
    </section>
  </main>

  <footer class="pt-footer">
    <small class="muted">
      Student science project — dosing math uses standard pool-chem rules per 10,000 gallons.
      Always confirm with test kits and product labels before treating a real pool.
    </small>
  </footer>

  <!-- Install prompt banner (PWA) 
  <div id="installBanner" class="install-banner" hidden>
    <div class="install-text">
      <strong>Add AquaLab to your Home Screen</strong>
      <div class="muted small" id="installHint">Install for faster access and full-screen scanning.</div>
    </div>
    <div class="install-actions">
      <button id="installBtn" class="btn">Add</button>
      <button id="installClose" class="btn-ghost">Not now</button>
    </div>
  </div>-->

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import { initPoolTestScanner } from "./scanner.js?v=dev16";
    const root = document.querySelector(".pooltest");
    initPoolTestScanner(root);
  </script>

  <script>
    // --- Add-to-Home Screen (A2HS) prompt ---
    //--const banner = document.getElementById("installBanner");--
    const btnInstall = document.getElementById("installBtn");
    const btnClose = document.getElementById("installClose");
    const hint = document.getElementById("installHint");

    const DISMISS_KEY = "pt_install_dismissed_v1";
    const dismissed = (() => { try { return localStorage.getItem(DISMISS_KEY) === "1"; } catch { return false; } })();

    function isStandalone() {
      return window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true;
    }
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    let deferredPrompt = null;

    function setBannerVisible(visible) {
      if (!banner) return;
      banner.hidden = !visible;
      document.body.classList.toggle("has-install-banner", !!visible);
    }

    function showBanner(message, showAddButton) {
      if (!banner || dismissed || isStandalone()) return;
      if (hint && message) hint.textContent = message;
      if (btnInstall) btnInstall.style.display = showAddButton ? "" : "none";
      setBannerVisible(true);
    }

    function hideBanner() {
      setBannerVisible(false);
    }

    btnClose?.addEventListener("click", () => {
      hideBanner();
      try { localStorage.setItem(DISMISS_KEY, "1"); } catch {}
    });

    btnInstall?.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      hideBanner();
    });

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showBanner("Install for faster access and full-screen scanning.", true);
    });

    window.addEventListener("load", () => {
      if (dismissed || isStandalone()) return;
      if (isIOS()) showBanner('On iPhone: tap Share → "Add to Home Screen".', false);
    });
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    }
  </script>
</body>
</html>